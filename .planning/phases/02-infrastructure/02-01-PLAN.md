---
phase: 02-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - templates/todo.md
  - hooks/pre-commit
autonomous: true
requirements:
  - INFR-01
  - INFR-02
  - INFR-03

must_haves:
  truths:
    - "templates/todo.md exists with all 6 frontmatter keys: created, priority, project, keywords, body, transcription"
    - "hooks/pre-commit rejects staged todo files missing 'created:' field — exits 1, stderr contains 'created'"
    - "hooks/pre-commit rejects staged todo files missing 'priority:' field — exits 1, stderr contains 'priority'"
    - "hooks/pre-commit rejects staged todo files whose basename does not match YYYY-MM-DD-*.md — exits 1, stderr contains 'YYYY-MM-DD'"
    - "hooks/pre-commit passes valid todo files and non-todo files silently (exit 0)"
    - "All 12 bats tests in tests/hooks.bats and tests/templates.bats pass"
  artifacts:
    - path: "templates/todo.md"
      provides: "Todo skeleton with YAML frontmatter placeholders"
      contains: "created:"
    - path: "hooks/pre-commit"
      provides: "Git pre-commit validation of todo frontmatter and filename"
      min_lines: 20
  key_links:
    - from: "hooks/pre-commit"
      to: "git diff --cached --name-only"
      via: "shell command to list staged files"
      pattern: "git diff.*--cached.*--name-only"
    - from: "hooks/pre-commit"
      to: "staged file content"
      via: "git show :path to read staged version"
      pattern: "git show :"
---

<objective>
Create `templates/todo.md` and `hooks/pre-commit` — the two infrastructure files that guard the todo system's data integrity. Every future commit through the pre-commit hook will be validated against these rules.

Purpose: Turn the 12 failing bats tests in `tests/hooks.bats` and `tests/templates.bats` from red to green. These tests were written in Phase 1 and define the exact contract.
Output: `templates/todo.md` (skeleton), `hooks/pre-commit` (executable validator)
</objective>

<execution_context>
@/home/leon/.claude/get-shit-done/workflows/execute-plan.md
@/home/leon/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@tests/hooks.bats
@tests/templates.bats
@tests/helpers/setup.bash
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create templates/todo.md skeleton</name>
  <files>templates/todo.md</files>
  <action>
Create the file `templates/todo.md` at the repo root with YAML frontmatter containing all 6 required keys with empty values (except the YAML block delimiters). The canonical format comes from `tests/hooks.bats` `create_valid_todo` helper:

```
---
created: 2026-01-01
priority: normal
project:
keywords:
body:
transcription:
---
```

Use placeholder values (not hardcoded dates) — the template is a skeleton, so `created:` and `priority:` should carry example values. The tests in `tests/templates.bats` only check that each key exists via `grep "key:"`, so any value (including empty) satisfies the contract.

Create the `templates/` directory if it does not exist. Make the file readable (no execute bit needed).
  </action>
  <verify>
    <automated>./tests/libs/bats-core/bin/bats tests/templates.bats</automated>
    <manual>All 7 template tests pass (exists + 6 field presence checks)</manual>
  </verify>
  <done>All 7 tests in tests/templates.bats pass. File exists at templates/todo.md containing all 6 frontmatter keys.</done>
</task>

<task type="auto">
  <name>Task 2: Create hooks/pre-commit validator</name>
  <files>hooks/pre-commit</files>
  <action>
Create `hooks/pre-commit` at the repo root as an executable shell script. The hook is tested by running it directly with `GIT_DIR` set (not via git's hook mechanism), so it must work standalone.

**Behaviour contract (from tests/hooks.bats):**

1. Get staged files: `git diff --cached --name-only`
2. For each staged file, check if its **basename** matches `YYYY-MM-DD-*.md` pattern (4 digits, dash, 2 digits, dash, 2 digits, dash, anything, .md). Non-matching filenames like `README.md` are silently skipped (exit 0).
3. For each staged todo file (matching basename pattern):
   - Check filename matches `YYYY-MM-DD-*.md`. If the basename does NOT match: print a message containing `YYYY-MM-DD` to stderr, exit 1.
   - Read staged content using `git show ":$filepath"` (reads the staged index version, not working tree).
   - If staged content does NOT contain `created:`: print a message containing `created` to stderr, exit 1.
   - If staged content does NOT contain `priority:`: print a message containing `priority` to stderr, exit 1.
4. If all checks pass: exit 0 (silently).

**Key implementation notes:**
- The test `pre-commit ignores non-todo staged files` stages `README.md` — the hook must NOT reject this. Filter by basename pattern only.
- Files like `open/buy-milk.md` must be caught: the basename `buy-milk.md` does not match `YYYY-MM-DD-*.md`.
- The `GIT_DIR` env var is set by tests; the hook uses `git diff --cached` and `git show` which respect `GIT_DIR` automatically.
- Tests run with `run "$SCRIPTS_DIR/hooks/pre-commit"` — `SCRIPTS_DIR` is the repo root. The hook does not need to change directory.
- Use `#!/bin/bash` shebang.
- After writing the file, run `chmod +x hooks/pre-commit`.

**Pattern matching in bash:** Use a case statement or `[[ $basename =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}-.+\.md$ ]]` to detect todo filenames.
  </action>
  <verify>
    <automated>./tests/libs/bats-core/bin/bats tests/hooks.bats</automated>
    <manual>All 5 hook tests pass: valid file passes, missing created fails, missing priority fails, bad filename fails, README.md passes</manual>
  </verify>
  <done>All 5 tests in tests/hooks.bats pass. hooks/pre-commit is executable and validates staged todo file content and filenames correctly.</done>
</task>

</tasks>

<verification>
Run both test files together to confirm all 12 infrastructure tests green:

```bash
./tests/libs/bats-core/bin/bats tests/hooks.bats tests/templates.bats
```

Expected: `12 tests, 0 failures`

Also confirm hooks/pre-commit is executable:
```bash
test -x hooks/pre-commit && echo "executable: ok"
```
</verification>

<success_criteria>
1. `templates/todo.md` exists with all 6 frontmatter keys (created, priority, project, keywords, body, transcription)
2. `hooks/pre-commit` exists, is executable, reads staged content via `git show`, and enforces filename pattern and frontmatter fields
3. `./tests/libs/bats-core/bin/bats tests/hooks.bats tests/templates.bats` reports `12 tests, 0 failures`
4. All Phase 2 requirements covered: INFR-01 (frontmatter validation), INFR-02 (filename validation), INFR-03 (template skeleton)
</success_criteria>

<output>
After completion, create `.planning/phases/02-infrastructure/02-01-SUMMARY.md` documenting:
- What was built (files created, key implementation decisions)
- How the hook reads staged content (git show :path)
- Filename pattern used for todo detection
- Test results (12/12 passing)
</output>
