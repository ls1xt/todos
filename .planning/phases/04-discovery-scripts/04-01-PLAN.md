---
phase: 04-discovery-scripts
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - list
autonomous: true
requirements:
  - SCPT-08
  - SCPT-09

must_haves:
  truths:
    - "`list` with no flags prints one line per open/ todo in `path  priority  project  [keywords]` format"
    - "`list --status done` shows done/ files and not open/ files"
    - "`list --project work` filters to only todos with `project: work` in frontmatter"
    - "`list --keyword meeting` filters to todos with `meeting` as a substring in the `keywords:` frontmatter field"
    - "`list --since 1d` shows only todos whose frontmatter `created:` date is within the last 1 day"
    - "`list --since 7d` excludes todos with `created: 2020-01-01` (date too old)"
    - "`list` with no matching files exits 0 with empty stdout (no error message)"
    - "`list --project nonexistent` exits 0 with empty stdout"
  artifacts:
    - path: "list"
      provides: "Bash script that filters and outputs todos in structured one-per-line format"
      min_lines: 40
  key_links:
    - from: "list"
      to: "open/ (or status dir)"
      via: "iterates .md files in the target status directory"
      pattern: "\\$STATUS_DIR"
    - from: "list"
      to: "frontmatter fields"
      via: "reads created/priority/project/keywords via grep or awk on each file"
      pattern: "grep.*priority\\|awk.*priority"
---

<objective>
Implement the `list` bash script at the repo root. The script scans todos by status directory, reads frontmatter fields, applies filters (--project, --keyword, --since, --status), and outputs one line per match in grep-friendly `path  priority  project  [keywords]` format.

Purpose: Enables users and Claude to find todos by project, keyword, or recency without leaving the terminal. The `list` output is Claude-parseable — one file per line with predictable columns.
Output: `list` script (executable), all 10 bats tests in `tests/list.bats` passing.
</objective>

<execution_context>
@/home/leon/.claude/get-shit-done/workflows/execute-plan.md
@/home/leon/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@tests/list.bats
@tests/helpers/setup.bash
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write and implement the `list` script</name>
  <files>list</files>
  <action>
Create an executable bash script at the repo root named `list` (no extension).

Script behavior (derived directly from tests/list.bats):

1. **Defaults:**
   - `STATUS="open"` (default status directory when --status not passed)
   - `PROJECT=""`, `KEYWORD=""`, `SINCE=""` (empty = no filter)

2. **Argument parsing:**
   - `--status VALUE` — which directory to scan (`open`, `done`, `blocked`, `dropped`)
   - `--project VALUE` — filter by exact match on `project:` frontmatter field
   - `--keyword VALUE` — filter by substring match on `keywords:` frontmatter field
   - `--since Nd` — filter by `created:` frontmatter date (N days ago cutoff); strip trailing `d`, compute cutoff date

3. **File scanning:**
   - Scan `${STATUS}/` directory for `*.md` files
   - If directory does not exist or is empty, exit 0 silently

4. **Frontmatter parsing (per file):**
   - Extract `priority:` value: `grep -m1 '^priority:' "$file" | sed 's/priority: *//'`
   - Extract `project:` value: `grep -m1 '^project:' "$file" | sed 's/project: *//'`
   - Extract `keywords:` value: `grep -m1 '^keywords:' "$file" | sed 's/keywords: *//'`
   - Extract `created:` value: `grep -m1 '^created:' "$file" | sed 's/created: *//'`

5. **Filter logic:**
   - `--project VALUE`: skip file if extracted `project` field != VALUE (exact match)
   - `--keyword VALUE`: skip file if VALUE is NOT a substring of the extracted `keywords` field
   - `--since Nd`: compute cutoff date as `date -d "N days ago" +%Y-%m-%d` (or `date -v-Nd +%Y-%m-%d` on macOS); skip file if `created` date < cutoff date. Use string comparison (YYYY-MM-DD is lexicographically sortable).

6. **Output format:**
   - One line per passing file: `path  priority  project  [keywords]`
   - Use two spaces or a tab as separator (tests use `--partial` matching, not exact column positions)
   - Example: `open/2026-01-01-work-task.md  high  work  meeting`

7. **Empty result:**
   - Exit 0, print nothing to stdout (no "no results" message)

8. **Make executable:**
   - Shebang: `#!/usr/bin/env bash`
   - Run `chmod +x list`

Implementation skeleton:

```bash
#!/usr/bin/env bash
set -e

STATUS="open"
PROJECT=""
KEYWORD=""
SINCE=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    --status)  STATUS="$2";  shift 2 ;;
    --project) PROJECT="$2"; shift 2 ;;
    --keyword) KEYWORD="$2"; shift 2 ;;
    --since)   SINCE="$2";   shift 2 ;;
    *) shift ;;
  esac
done

# Compute cutoff date if --since provided
CUTOFF=""
if [[ -n "$SINCE" ]]; then
  DAYS="${SINCE%d}"
  # Try GNU date first, fall back to BSD date
  CUTOFF=$(date -d "${DAYS} days ago" +%Y-%m-%d 2>/dev/null \
           || date -v-"${DAYS}"d +%Y-%m-%d 2>/dev/null || true)
fi

STATUS_DIR="${STATUS}"

[[ -d "$STATUS_DIR" ]] || exit 0

for file in "$STATUS_DIR"/*.md; do
  [[ -f "$file" ]] || continue

  PRIORITY=$(grep -m1 '^priority:' "$file" | sed 's/priority:[[:space:]]*//')
  PROJECT_VAL=$(grep -m1 '^project:' "$file" | sed 's/project:[[:space:]]*//')
  KEYWORDS_VAL=$(grep -m1 '^keywords:' "$file" | sed 's/keywords:[[:space:]]*//')
  CREATED_VAL=$(grep -m1 '^created:' "$file" | sed 's/created:[[:space:]]*//')

  # Apply --project filter (exact match)
  if [[ -n "$PROJECT" && "$PROJECT_VAL" != "$PROJECT" ]]; then
    continue
  fi

  # Apply --keyword filter (substring match)
  if [[ -n "$KEYWORD" && "$KEYWORDS_VAL" != *"$KEYWORD"* ]]; then
    continue
  fi

  # Apply --since filter (date comparison)
  if [[ -n "$CUTOFF" && "$CREATED_VAL" < "$CUTOFF" ]]; then
    continue
  fi

  echo "${file}  ${PRIORITY}  ${PROJECT_VAL}  ${KEYWORDS_VAL}"
done
```

Write this file with the Write tool (do NOT use Bash heredoc/cat to create it).
After writing, run: `chmod +x list`
  </action>
  <verify>
    <automated>cd /home/leon/todos && ./tests/libs/bats-core/bin/bats tests/list.bats</automated>
    <manual>All 10 tests in list.bats should pass: default open/ listing, output format, --status, --project filter, --keyword filter, --since 1d and 7d filters, empty result exits 0, nonexistent project exits 0.</manual>
  </verify>
  <done>
    `./tests/libs/bats-core/bin/bats tests/list.bats` reports 10 tests, 0 failures.
    File `list` exists at repo root, is executable, and has the correct shebang.
  </done>
</task>

</tasks>

<verification>
Run the list test suite:
```bash
./tests/libs/bats-core/bin/bats tests/list.bats
```
Expected: 10 passed, 0 failed.

Spot-check:
```bash
ls -la list          # executable bit set
head -1 list         # #!/usr/bin/env bash
```
</verification>

<success_criteria>
- `list` script exists at repo root with executable bit set
- All 10 tests in tests/list.bats pass
- SCPT-08: `list` filters by --project, --keyword, --since, --status; default is open
- SCPT-09: Output is one-per-line in `path  priority  project  [keywords]` format, grep-friendly
</success_criteria>

<output>
After completion, create `.planning/phases/04-discovery-scripts/04-01-SUMMARY.md` with what was built, any decisions made, and the test result.
</output>
