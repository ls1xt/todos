---
phase: 04-discovery-scripts
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - review
autonomous: true
requirements:
  - SCPT-10

must_haves:
  truths:
    - "`review` with no args shows todos from last 7 days grouped by status (open section, done section)"
    - "`review` output includes per-status counts (e.g. `open (2)` or `2 open`)"
    - "`review --days 14` shows todos from last 14 days"
    - "`review --days 0` exits 0 with empty output or headers only (no error)"
    - "When both open and done todos exist, both `open` and `done` labels appear in the output as section headers"
  artifacts:
    - path: "review"
      provides: "Bash script that groups todos by status with per-status counts for a time window"
      min_lines: 30
  key_links:
    - from: "review"
      to: "open/, done/, blocked/, dropped/ directories"
      via: "iterates each status directory, filters by created: date within window"
      pattern: "for.*STATUS_DIR"
    - from: "review"
      to: "frontmatter created: field"
      via: "grep -m1 to extract date, compare against cutoff"
      pattern: "grep.*created"
---

<objective>
Implement the `review` bash script at the repo root. The script scans all status directories (open/, done/, blocked/, dropped/) for todos whose frontmatter `created:` date falls within the last N days (default 7), groups results by status, and prints section headers with per-status counts.

Purpose: Gives users a quick digest of recent activity across all statuses — what's been done, what's still open, what got blocked or dropped.
Output: `review` script (executable), all 5 bats tests in `tests/review.bats` passing.
</objective>

<execution_context>
@/home/leon/.claude/get-shit-done/workflows/execute-plan.md
@/home/leon/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@tests/review.bats
@tests/helpers/setup.bash
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write and implement the `review` script</name>
  <files>review</files>
  <action>
Create an executable bash script at the repo root named `review` (no extension).

Script behavior (derived directly from tests/review.bats):

1. **Defaults:**
   - `DAYS=7` (window in days when --days not passed)

2. **Argument parsing:**
   - `--days N` — override the review window (N = integer; N=0 means show nothing / empty window)

3. **Cutoff date computation:**
   - `CUTOFF=$(date -d "${DAYS} days ago" +%Y-%m-%d 2>/dev/null || date -v-"${DAYS}"d +%Y-%m-%d 2>/dev/null || true)`
   - For `--days 0`: cutoff = today's date; any file with `created:` < today is excluded. The test asserts `assert_success` only — an empty output (or headers-only output) is acceptable.

4. **Status directories to scan:**
   - Always scan in order: `open`, `done`, `blocked`, `dropped`
   - Skip directories that don't exist

5. **Per-directory processing:**
   - Collect matching files: for each `.md` file in the directory, extract `created:` with `grep -m1 '^created:'`, compare to cutoff using string comparison (`[[ "$CREATED_VAL" > "$CUTOFF" || "$CREATED_VAL" == "$CUTOFF" ]]`)
   - Count matching files
   - If count > 0: print a section header and list the filenames

6. **Output format (Claude's discretion per CONTEXT.md):**
   - Section header must contain the status name and the count
   - Acceptable formats: `open (2)`, `open: 2`, `=== open (2) ===`, `## open (2)`
   - Under each header: list filenames (basename or relative path, one per line)
   - Tests check `--partial "open"`, `--partial "done"`, `--partial "2"` — any readable format works

7. **--days 0 edge case:**
   - Cutoff is today. Files created today have `created: YYYY-MM-DD` equal to today. String comparison `>=` today → these files ARE included (today is within the 0-days-ago window). If DAYS=0, no files match since nothing was created in the future. Either produce empty output or headers with 0 counts — both pass the test.
   - Simplest correct approach: if DAYS=0, print nothing and exit 0.

8. **Make executable:**
   - Shebang: `#!/usr/bin/env bash`
   - Run `chmod +x review`

Implementation skeleton:

```bash
#!/usr/bin/env bash
set -e

DAYS=7

while [[ $# -gt 0 ]]; do
  case "$1" in
    --days) DAYS="$2"; shift 2 ;;
    *) shift ;;
  esac
done

# Edge case: 0-day window shows nothing
if [[ "$DAYS" -eq 0 ]]; then
  exit 0
fi

CUTOFF=$(date -d "${DAYS} days ago" +%Y-%m-%d 2>/dev/null \
         || date -v-"${DAYS}"d +%Y-%m-%d 2>/dev/null || true)

for STATUS in open done blocked dropped; do
  [[ -d "$STATUS" ]] || continue

  MATCHES=()
  for file in "$STATUS"/*.md; do
    [[ -f "$file" ]] || continue
    CREATED=$(grep -m1 '^created:' "$file" | sed 's/created:[[:space:]]*//')
    # Include if created >= cutoff
    if [[ "$CREATED" > "$CUTOFF" || "$CREATED" == "$CUTOFF" ]]; then
      MATCHES+=("$file")
    fi
  done

  COUNT="${#MATCHES[@]}"
  if [[ "$COUNT" -gt 0 ]]; then
    echo "${STATUS} (${COUNT})"
    for match in "${MATCHES[@]}"; do
      echo "  $match"
    done
  fi
done
```

Write this file with the Write tool (do NOT use Bash heredoc/cat to create it).
After writing, run: `chmod +x review`
  </action>
  <verify>
    <automated>cd /home/leon/todos && ./tests/libs/bats-core/bin/bats tests/review.bats</automated>
    <manual>All 5 tests in review.bats should pass: grouped by status, shows counts, --days 14 works, --days 0 exits 0, open and done both appear when both have files.</manual>
  </verify>
  <done>
    `./tests/libs/bats-core/bin/bats tests/review.bats` reports 5 tests, 0 failures.
    File `review` exists at repo root, is executable, and has the correct shebang.
  </done>
</task>

</tasks>

<verification>
Run the review test suite:
```bash
./tests/libs/bats-core/bin/bats tests/review.bats
```
Expected: 5 passed, 0 failed.

Spot-check:
```bash
ls -la review        # executable bit set
head -1 review       # #!/usr/bin/env bash
```
</verification>

<success_criteria>
- `review` script exists at repo root with executable bit set
- All 5 tests in tests/review.bats pass
- SCPT-10: `review [--days N]` shows todos from last N days (default 7) grouped by status with counts
</success_criteria>

<output>
After completion, create `.planning/phases/04-discovery-scripts/04-02-SUMMARY.md` with what was built, any decisions made, and the test result.
</output>
