---
phase: 04-discovery-scripts
plan: 03
type: execute
wave: 2
depends_on:
  - "04-01"
  - "04-02"
files_modified:
  - session
autonomous: true
requirements:
  - SCPT-11

must_haves:
  truths:
    - "`session business` calls `tmux new-session` with `-s todo` when no session is running"
    - "`session personal` calls `tmux new-session` with `-s todo` when no session is running"
    - "`session` with no argument exits non-zero OR prints usage text containing `usage`"
    - "`session business` calls `tmux attach-session` when a `todo` session is already running"
    - "All bats tests across all test files report 100% passing after this plan completes"
  artifacts:
    - path: "session"
      provides: "Bash script that creates or attaches to a tmux session named `todo` for the specified repo"
      min_lines: 20
  key_links:
    - from: "session"
      to: "tmux has-session -t todo"
      via: "checks if session exists before deciding new-session vs attach-session"
      pattern: "tmux has-session"
    - from: "session"
      to: "tmux new-session"
      via: "called when has-session fails; must include -s todo"
      pattern: "tmux new-session.*todo"
---

<objective>
Implement the `session` bash script at the repo root and verify the complete test suite (100% pass). The script creates or attaches to a tmux session named `todo`, cds into the correct repo (`~/business` or `~/personal`), and launches `claude`.

Purpose: Lets users resume work from any terminal in one command — the entry point for the voice-driven workflow.
Output: `session` script (executable), all 4 bats tests in `tests/session.bats` passing, and full `bats tests/` suite at 100%.
</objective>

<execution_context>
@/home/leon/.claude/get-shit-done/workflows/execute-plan.md
@/home/leon/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@tests/session.bats
@tests/helpers/setup.bash
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write and implement the `session` script</name>
  <files>session</files>
  <action>
Create an executable bash script at the repo root named `session` (no extension).

Script behavior (derived directly from tests/session.bats):

1. **Argument:**
   - First positional arg: `business` or `personal`
   - No arg → print usage to stderr and exit 1 (or non-zero). Test: `[ "$status" -ne 0 ] || assert_output --partial "usage"` — either condition satisfies the test.

2. **Repo path resolution:**
   - `business` → `REPO_PATH="$HOME/business"`
   - `personal` → `REPO_PATH="$HOME/personal"`
   - Use env var override if set: `TODOS_BUSINESS_REPO` and `TODOS_PERSONAL_REPO`
   - Priority: env var > default path

3. **Session name:**
   - Always `todo` (hardcoded)

4. **Check if session exists:**
   - `tmux has-session -t todo 2>/dev/null`

5. **If session NOT running (has-session exits non-zero):**
   - Create new session: `tmux new-session -d -s todo -c "$REPO_PATH" -e "default-command='bash -c claude'" ...`
   - The mock in tests just checks that `new-session` is called and that `todo` appears in the tmux-calls.log
   - Minimal working command: `tmux new-session -d -s todo`
   - Launching `claude` is implementation detail (tests don't verify `claude` was launched, only that `new-session` was called with `todo`)
   - Simple approach: `tmux new-session -d -s todo -c "$REPO_PATH"` then `tmux send-keys -t todo "claude" Enter`

6. **If session IS running (has-session exits 0):**
   - Attach: `tmux attach-session -t todo`

7. **Make executable:**
   - Shebang: `#!/usr/bin/env bash`
   - Run `chmod +x session`

**Key insight from test mock:** The tests inject a fake `tmux` binary into `$PATH` that logs all calls to `$REPO_DIR/tmux-calls.log`. The test for new-session checks `grep "new-session" tmux-calls.log` and `assert_output --partial "todo"`. The test for attach-session overrides the mock so `has-session` returns 0, then checks `grep "attach-session" tmux-calls.log`. The script just needs to call the right tmux subcommands — the actual tmux behavior is irrelevant in tests.

Implementation:

```bash
#!/usr/bin/env bash
set -e

REPO_ARG="$1"

if [[ -z "$REPO_ARG" ]]; then
  echo "usage: session [business|personal]" >&2
  exit 1
fi

case "$REPO_ARG" in
  business)
    REPO_PATH="${TODOS_BUSINESS_REPO:-$HOME/business}"
    ;;
  personal)
    REPO_PATH="${TODOS_PERSONAL_REPO:-$HOME/personal}"
    ;;
  *)
    echo "usage: session [business|personal]" >&2
    exit 1
    ;;
esac

SESSION="todo"

if tmux has-session -t "$SESSION" 2>/dev/null; then
  tmux attach-session -t "$SESSION"
else
  tmux new-session -d -s "$SESSION" -c "$REPO_PATH"
  tmux send-keys -t "$SESSION" "claude" Enter
  tmux attach-session -t "$SESSION"
fi
```

Write this file with the Write tool (do NOT use Bash heredoc/cat to create it).
After writing, run: `chmod +x session`
  </action>
  <verify>
    <automated>cd /home/leon/todos && ./tests/libs/bats-core/bin/bats tests/session.bats</automated>
    <manual>All 4 session.bats tests pass: business creates session with todo, personal creates session with todo, no arg prints usage or exits non-zero, attaches when session already running.</manual>
  </verify>
  <done>
    `./tests/libs/bats-core/bin/bats tests/session.bats` reports 4 tests, 0 failures.
    File `session` exists at repo root, is executable, and has the correct shebang.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run full bats suite and confirm 100% passing</name>
  <files></files>
  <action>
Run the complete bats test suite to confirm all tests pass across all phases.

```bash
./tests/libs/bats-core/bin/bats tests/add.bats tests/done.bats tests/block.bats tests/drop.bats tests/hooks.bats tests/templates.bats tests/list.bats tests/review.bats tests/session.bats
```

If any tests fail, diagnose and fix the failing script before proceeding. Common fixes:
- `list`: date comparison edge case — ensure `--since` uses frontmatter `created:` field, NOT file mtime
- `review`: count output — ensure the number appears in the section header line
- `session`: tmux mock logs — ensure correct subcommand names are used (`new-session`, `attach-session`, `has-session`)

Do NOT move on until 0 failures are reported.
  </action>
  <verify>
    <automated>cd /home/leon/todos && ./tests/libs/bats-core/bin/bats tests/add.bats tests/done.bats tests/block.bats tests/drop.bats tests/hooks.bats tests/templates.bats tests/list.bats tests/review.bats tests/session.bats 2>&1 | tail -5</automated>
    <manual>Final line should report the total count with 0 failures. All previously passing tests (add, done, block, drop, hooks, templates) must still pass.</manual>
  </verify>
  <done>
    Full bats suite reports 0 failures across all test files.
    `bats tests/` reports 100% passing — Phase 4 success criteria met.
  </done>
</task>

</tasks>

<verification>
Run the session test suite, then the full suite:
```bash
./tests/libs/bats-core/bin/bats tests/session.bats
./tests/libs/bats-core/bin/bats tests/add.bats tests/done.bats tests/block.bats tests/drop.bats tests/hooks.bats tests/templates.bats tests/list.bats tests/review.bats tests/session.bats 2>&1 | tail -3
```
Expected: session.bats 4 passed. Full suite: 0 failures.
</verification>

<success_criteria>
- `session` script exists at repo root with executable bit set
- All 4 tests in tests/session.bats pass
- SCPT-11: `session [business|personal]` creates or attaches to tmux session `todo`, cds into correct repo, launches `claude`
- Full bats suite (all .bats files) reports 100% passing — zero failures
</success_criteria>

<output>
After completion, create `.planning/phases/04-discovery-scripts/04-03-SUMMARY.md` with what was built, any decisions made, and the test results (both session.bats and full suite total).
</output>
