---
phase: 01-test-suite
plan: 03
type: tdd
wave: 2
depends_on:
  - 01-01
files_modified:
  - tests/list.bats
  - tests/review.bats
  - tests/session.bats
autonomous: true
requirements:
  - TDD-04

must_haves:
  truths:
    - "tests/list.bats, tests/review.bats, tests/session.bats exist and are valid bats files"
    - "All tests in these three files fail (scripts not yet implemented — TDD red state)"
    - "list.bats covers all filter flags: --project, --keyword, --since, --status; default behavior; output format"
    - "review.bats covers default 7-day window and --days N, verifies grouped output with per-status counts"
    - "session.bats covers tmux session creation and attach scenarios (mocked or marked integration-only)"
  artifacts:
    - path: "tests/list.bats"
      provides: "list script test cases (all filter combinations + output format)"
      min_lines: 60
    - path: "tests/review.bats"
      provides: "review script test cases (default and --days N, grouped output)"
      min_lines: 35
    - path: "tests/session.bats"
      provides: "session script test cases (tmux create/attach)"
      min_lines: 20
  key_links:
    - from: "tests/list.bats"
      to: "tests/helpers/setup.bash"
      via: "load statement"
      pattern: "load.*helpers/setup"
    - from: "tests/list.bats"
      to: "$SCRIPTS_DIR/list"
      via: "run $SCRIPTS_DIR/list in test body"
      pattern: "run.*SCRIPTS_DIR.*list"
    - from: "tests/session.bats"
      to: "$SCRIPTS_DIR/session"
      via: "run $SCRIPTS_DIR/session or mock"
      pattern: "run.*SCRIPTS_DIR.*session|skip.*integration"
---

<objective>
Write bats test files for the discovery scripts: list, review, session. All tests will fail — the scripts don't exist. This is the red baseline for Phase 4.

Purpose: Specifies the contract for list (filter/output), review (grouping/counts), and session (tmux orchestration) before any implementation.
Output: Three failing .bats files covering all discovery script behaviors.
</objective>

<execution_context>
@/home/leon/.claude/get-shit-done/workflows/execute-plan.md
@/home/leon/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-test-suite/01-CONTEXT.md
@.planning/phases/01-test-suite/01-01-SUMMARY.md
</context>

<feature>
  <name>Discovery Script Test Suite</name>
  <files>
    tests/list.bats
    tests/review.bats
    tests/session.bats
  </files>
  <behavior>
    All test files follow the same pattern as Plan 02:
    ```bash
    #!/usr/bin/env bats
    load "helpers/setup"
    setup() { setup_repo; }
    teardown() { teardown_repo; }
    ```

    === tests/list.bats cases ===
    Create helper todos in setup: populate open/, done/, blocked/ with a few .md files containing frontmatter, so filter tests have data to work with. Use a local create_todo() helper function within the file.

    - "list with no flags prints open todos one per line" — run $SCRIPTS_DIR/list; assert_success; assert_output --partial "open/"
    - "list output format is: path  priority  project  [keywords]" — assert_output matches pattern with those fields
    - "list --status done shows done/ files not open/" — assert_output --partial "done/"; refute_output --partial "open/"
    - "list --status blocked shows blocked/ files"
    - "list --project filters by project frontmatter field" — create two todos with different projects; run list --project work; only work-project file in output
    - "list --keyword filters by keyword frontmatter" — create todos with different keywords; filter by one keyword
    - "list --since 1d only shows files from last 1 day" — create a file dated today and one with old date in frontmatter; since 1d shows only today's
    - "list --since 7d shows files from last 7 days"
    - "list with no matching files exits 0 with empty output" — (empty repo case)
    - "list --project nonexistent returns empty output"

    === tests/review.bats cases ===
    - "review with no args shows todos from last 7 days grouped by status" — create files in open/ and done/; run $SCRIPTS_DIR/review; assert_output --partial "open" and "done" sections
    - "review output includes per-status counts" — assert_output matches "open (N)" or similar count format
    - "review --days 14 shows last 14 days" — run review --days 14; assert_success
    - "review --days 0 shows empty output or just headers" — edge case
    - "review groups files correctly (open in open section, done in done section)"

    === tests/session.bats cases ===
    The session script requires tmux and a real repo path — true unit testing is not practical. Use one of:
    Option A: Mock tmux by placing a fake `tmux` script earlier in PATH that records invocations
    Option B: Mark tests as integration-only with a skip if tmux is unavailable

    Use Option A (mock tmux) per Claude's discretion:

    - "session business creates tmux session named 'todo' if not running" — place mock tmux at $REPO_DIR/bin/tmux that records args; PATH="$REPO_DIR/bin:$PATH" run $SCRIPTS_DIR/session business; assert_success; check mock recorded "new-session" with name "todo"
    - "session personal creates tmux session named 'todo'" — same with personal arg
    - "session with no arg defaults to open or prints usage" — assert_failure or assert_output --partial "usage" (depending on implementation choice; test should document expected behavior)
    - "session attaches if tmux session 'todo' already running" — mock tmux to return success for has-session; verify attach-session called

    Note: If tmux mocking proves too complex during execution, the executor may use `skip "integration test — requires tmux"` for individual tests and document this in the SUMMARY. The test stubs must still exist.
  </behavior>
  <implementation>
    Write all three test files with failing tests as specified.

    For list.bats, create a local helper `create_todo()` that writes a minimal .md file with YAML frontmatter:
    ```bash
    create_todo() {
      local dir="$1" name="$2" priority="${3:-normal}" project="${4:-}" keywords="${5:-}"
      local filepath="$REPO_DIR/$dir/$name"
      cat > "$filepath" <<EOF
    ---
    created: $(date +%Y-%m-%d)
    priority: $priority
    project: $project
    keywords: $keywords
    body:
    transcription:
    ---
    EOF
      git -C "$REPO_DIR" add "$filepath"
    }
    ```

    Do NOT implement the actual scripts. Only write the test files.
    All tests will fail because $SCRIPTS_DIR/list, $SCRIPTS_DIR/review, $SCRIPTS_DIR/session do not exist.
  </implementation>
</feature>

<verification>
After writing all three files:
```bash
./tests/libs/bats-core/bin/bats tests/list.bats tests/review.bats tests/session.bats 2>&1 | tail -20
```
Expected: All tests shown as "not ok". Zero "ok" lines. Exit code non-zero.

Also verify full suite still all-red:
```bash
./test 2>&1 | grep -E "^(ok|not ok)" | wc -l
./test 2>&1 | grep "^ok" | wc -l  # should be 0
```
</verification>

<success_criteria>
- tests/list.bats has at least 9 test cases covering all filter flags and output format
- tests/review.bats has at least 5 test cases covering default and --days N with grouped output
- tests/session.bats has at least 4 test cases (using tmux mock or documented skip strategy)
- All tests fail when run (TDD red state confirmed)
- Running ./test with all nine .bats files produces zero passing tests
</success_criteria>

<output>
After completion, create `.planning/phases/01-test-suite/01-03-SUMMARY.md`
</output>
