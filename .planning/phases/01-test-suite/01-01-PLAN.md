---
phase: 01-test-suite
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/libs/bats-core
  - tests/libs/bats-assert
  - tests/libs/bats-support
  - tests/helpers/setup.bash
  - test
  - .gitmodules
autonomous: true
requirements:
  - TDD-01

must_haves:
  truths:
    - "Running ./tests/libs/bats-core/bin/bats --version prints a version number without error"
    - "assert_output and assert_failure helpers are available to test files that source bats-assert/load"
    - "A shared setup.bash helper exists that creates a fresh temp git repo and sets PATH to include the project root"
    - "The ./test convenience script runs the full suite via the vendored bats binary"
  artifacts:
    - path: "tests/libs/bats-core"
      provides: "bats test runner (vendored git submodule)"
      contains: "bin/bats"
    - path: "tests/libs/bats-assert"
      provides: "assert_output, assert_failure, assert_success helpers"
    - path: "tests/libs/bats-support"
      provides: "bats-support (required by bats-assert)"
    - path: "tests/helpers/setup.bash"
      provides: "shared BATS setup/teardown: temp git repo creation, PATH configuration"
      min_lines: 20
    - path: "test"
      provides: "convenience script to run full suite"
      contains: "bats-core/bin/bats"
    - path: ".gitmodules"
      provides: "git submodule registrations for all three bats libs"
  key_links:
    - from: "tests/helpers/setup.bash"
      to: "tests/libs/bats-assert/load"
      via: "load statement in setup.bash"
      pattern: "load.*bats-assert"
    - from: "test"
      to: "tests/libs/bats-core/bin/bats"
      via: "exec or direct invocation"
      pattern: "bats-core/bin/bats"
---

<objective>
Vendor bats-core, bats-assert, and bats-support as git submodules under tests/libs/. Create the shared test helper (setup.bash) that all test files will source. Add a ./test convenience script at the repo root.

Purpose: Every subsequent test file depends on these libs. This plan establishes the foundation so Plans 02 and 03 can write test files that actually run (and fail correctly).
Output: Vendored bats libs, shared helper, convenience runner.
</objective>

<execution_context>
@/home/leon/.claude/get-shit-done/workflows/execute-plan.md
@/home/leon/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-test-suite/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Vendor bats libs as git submodules</name>
  <files>
    tests/libs/bats-core
    tests/libs/bats-assert
    tests/libs/bats-support
    .gitmodules
  </files>
  <action>
    Add three git submodules into tests/libs/:

    ```bash
    mkdir -p tests/libs
    git submodule add https://github.com/bats-core/bats-core.git tests/libs/bats-core
    git submodule add https://github.com/bats-core/bats-assert.git tests/libs/bats-assert
    git submodule add https://github.com/bats-core/bats-support.git tests/libs/bats-support
    ```

    After adding, run `git submodule update --init` to confirm all three are populated.

    Do NOT install bats system-wide. The entire suite must run with no system dependencies beyond git and bash.
  </action>
  <verify>
    <automated>./tests/libs/bats-core/bin/bats --version</automated>
    <manual>Check .gitmodules contains all three entries; check tests/libs/bats-assert/load exists</manual>
  </verify>
  <done>
    `./tests/libs/bats-core/bin/bats --version` exits 0 and prints version string.
    .gitmodules lists bats-core, bats-assert, bats-support.
    tests/libs/bats-assert/load and tests/libs/bats-support/load both exist.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create shared test helper and convenience runner</name>
  <files>
    tests/helpers/setup.bash
    test
  </files>
  <action>
    Create `tests/helpers/setup.bash` â€” sourced by every .bats file's setup():

    ```bash
    #!/usr/bin/env bash
    # Shared bats helpers for todos-general test suite

    # Load bats-support and bats-assert (order matters: support first)
    load "$(dirname "$BATS_TEST_DIRNAME")/libs/bats-support/load"
    load "$(dirname "$BATS_TEST_DIRNAME")/libs/bats-assert/load"

    # Create a fresh isolated temp git repo for each test.
    # Sets: REPO_DIR (path to temp repo), SCRIPTS_DIR (path to project root scripts)
    setup_repo() {
      REPO_DIR="$(mktemp -d)"
      SCRIPTS_DIR="$(cd "$BATS_TEST_DIRNAME/.." && pwd)"

      cd "$REPO_DIR"
      git init -q
      git config user.email "test@test.com"
      git config user.name "Test"

      # Create the standard directory structure
      mkdir -p open done blocked dropped

      # Initial commit so git status works
      git commit -q --allow-empty -m "init"

      export REPO_DIR SCRIPTS_DIR
    }

    # Remove temp repo after each test
    teardown_repo() {
      rm -rf "$REPO_DIR"
    }
    ```

    Note: `BATS_TEST_DIRNAME` is set by bats to the directory containing the running .bats file (i.e., `tests/`). So `dirname "$BATS_TEST_DIRNAME"` is the repo root.

    Create `test` convenience script at repo root (chmod +x):

    ```bash
    #!/usr/bin/env bash
    # Run the full bats test suite using vendored bats-core
    SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
    exec "$SCRIPT_DIR/tests/libs/bats-core/bin/bats" "$SCRIPT_DIR/tests/" "$@"
    ```

    Make it executable: `chmod +x test`
  </action>
  <verify>
    <automated>bash -n tests/helpers/setup.bash && bash -n test && echo "syntax ok"</automated>
    <manual>Confirm test is executable (ls -l test shows -rwxr-xr-x)</manual>
  </verify>
  <done>
    `tests/helpers/setup.bash` exists with setup_repo() and teardown_repo() functions.
    `test` script exists, is executable, and references tests/libs/bats-core/bin/bats.
    Both files pass bash -n syntax check.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `./tests/libs/bats-core/bin/bats --version` exits 0
2. `cat .gitmodules` shows all three bats submodule entries
3. `bash -n tests/helpers/setup.bash` exits 0
4. `./test --help` runs without error (bats prints help)
</verification>

<success_criteria>
- Three bats libs vendored as git submodules in tests/libs/
- tests/helpers/setup.bash provides setup_repo() and teardown_repo() and loads bats-assert/bats-support
- ./test convenience script runs the full suite via vendored binary
- Zero system-level bats dependency required
</success_criteria>

<output>
After completion, create `.planning/phases/01-test-suite/01-01-SUMMARY.md`
</output>
