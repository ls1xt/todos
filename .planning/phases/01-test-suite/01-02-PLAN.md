---
phase: 01-test-suite
plan: 02
type: tdd
wave: 2
depends_on:
  - 01-01
files_modified:
  - tests/hooks.bats
  - tests/templates.bats
  - tests/add.bats
  - tests/done.bats
  - tests/block.bats
  - tests/drop.bats
autonomous: true
requirements:
  - TDD-02
  - TDD-03

must_haves:
  truths:
    - "Running ./test (or bats tests/) shows tests/hooks.bats, tests/templates.bats, tests/add.bats, tests/done.bats, tests/block.bats, tests/drop.bats in output"
    - "Every test in these six files fails — no passing tests (scripts not yet implemented)"
    - "hooks.bats covers: valid file passes pre-commit, missing frontmatter fails, bad filename fails"
    - "templates.bats covers: templates/todo.md exists with all six frontmatter placeholders"
    - "add.bats covers: happy path, all flags (--priority --keywords --project --body --transcription), non-TTY behavior"
    - "done/block/drop.bats each cover: successful move, zero-match error (stderr + exit 1), multiple-match error, commit message format"
  artifacts:
    - path: "tests/hooks.bats"
      provides: "pre-commit hook test cases"
      min_lines: 40
    - path: "tests/templates.bats"
      provides: "template structure test cases"
      min_lines: 15
    - path: "tests/add.bats"
      provides: "add script test cases"
      min_lines: 60
    - path: "tests/done.bats"
      provides: "done script test cases"
      min_lines: 40
    - path: "tests/block.bats"
      provides: "block script test cases"
      min_lines: 40
    - path: "tests/drop.bats"
      provides: "drop script test cases"
      min_lines: 40
  key_links:
    - from: "tests/hooks.bats"
      to: "tests/helpers/setup.bash"
      via: "load statement at top of file"
      pattern: "load.*helpers/setup"
    - from: "tests/add.bats"
      to: "$SCRIPTS_DIR/add"
      via: "run $SCRIPTS_DIR/add in test body"
      pattern: "run.*SCRIPTS_DIR.*add"
---

<objective>
Write bats test files for infrastructure (pre-commit hook, template) and core scripts (add, done, block, drop). All tests will fail — the scripts don't exist yet. This is the red baseline for Phases 2 and 3.

Purpose: TDD requires tests written before implementation. These files define the contract every implementation must satisfy.
Output: Six failing .bats files that specify complete behavior for infrastructure and core scripts.
</objective>

<execution_context>
@/home/leon/.claude/get-shit-done/workflows/execute-plan.md
@/home/leon/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-test-suite/01-CONTEXT.md
@.planning/phases/01-test-suite/01-01-SUMMARY.md
</context>

<feature>
  <name>Infrastructure and Core Script Test Suite</name>
  <files>
    tests/hooks.bats
    tests/templates.bats
    tests/add.bats
    tests/done.bats
    tests/block.bats
    tests/drop.bats
  </files>
  <behavior>
    All test files follow this pattern:
    ```bash
    #!/usr/bin/env bats
    load "helpers/setup"

    setup() { setup_repo; }
    teardown() { teardown_repo; }

    @test "description" {
      run $SCRIPTS_DIR/script args
      assert_failure  # or assert_success
      assert_output --partial "expected text"
    }
    ```

    === tests/hooks.bats cases ===
    - "valid todo file passes pre-commit hook" — create YYYY-MM-DD-test.md with created+priority frontmatter, git add it, run hooks/pre-commit via PATH override; assert_success
    - "pre-commit rejects file missing 'created' field" — create file without created:, assert_failure + assert_output --partial "created"
    - "pre-commit rejects file missing 'priority' field" — create file without priority:, assert_failure + assert_output --partial "priority"
    - "pre-commit rejects file with bad filename (no date prefix)" — create buy-milk.md, assert_failure + assert_output --partial "YYYY-MM-DD"
    - "pre-commit ignores non-todo staged files" — stage a README.md, assert_success

    === tests/templates.bats cases ===
    - "templates/todo.md exists" — run test -f "$SCRIPTS_DIR/templates/todo.md"; assert_success
    - "template contains created placeholder" — run grep "created:" "$SCRIPTS_DIR/templates/todo.md"; assert_success
    - "template contains priority placeholder" — run grep "priority:" ...; assert_success
    - "template contains project placeholder" — same pattern
    - "template contains keywords placeholder" — same
    - "template contains body placeholder" — same
    - "template contains transcription placeholder" — same

    === tests/add.bats cases ===
    - "add creates file in open/ with date prefix" — run $SCRIPTS_DIR/add "buy milk"; assert_success; check open/YYYY-MM-DD-buy-milk.md exists (use glob or ls with pattern)
    - "add prints 'created: open/...' on stdout" — assert_output --partial "created: open/"
    - "add auto-commits the file" — run git log --oneline; assert_output --partial "add: buy milk"
    - "add --priority sets frontmatter" — run add "task" --priority high; check file contains "priority: high"
    - "add --keywords sets frontmatter" — run add "task" --keywords "foo,bar"; check file contains "keywords: foo,bar"
    - "add --project sets frontmatter" — check file contains "project: ..."
    - "add --body sets frontmatter" — check file contains body content
    - "add --transcription sets frontmatter" — check file contains transcription content
    - "add without TTY does not open editor" — run add "task" with stdin closed (< /dev/null); assert_success (no blocking)

    === tests/done.bats cases ===
    - "done moves file from open/ to done/" — create open/2026-01-01-fix-bug.md, run done "fix-bug"; assert_success; check done/2026-01-01-fix-bug.md exists; check open/ no longer has file
    - "done auto-commits with 'done: <title>' message" — run git log --oneline; assert_output --partial "done: fix bug" (or title slug)
    - "done with zero matches exits 1 and prints to stderr" — run done "nonexistent"; assert_failure; assert_output --partial "no match" (stderr captured by bats)
    - "done with multiple matches lists candidates and does not move any" — create two matching files, run done "fix"; assert_failure; assert_output --partial both filenames

    === tests/block.bats cases ===
    - "block moves file from open/ to blocked/" — same pattern as done but to blocked/
    - "block auto-commits with 'block: <title>'"
    - "block with zero matches exits 1"
    - "block with multiple matches lists candidates"

    === tests/drop.bats cases ===
    - "drop moves file from open/ to dropped/" — same pattern but to dropped/
    - "drop auto-commits with 'drop: <title>'"
    - "drop with zero matches exits 1"
    - "drop with multiple matches lists candidates"
  </behavior>
  <implementation>
    Write all test files with the failing tests described above. Scripts don't exist yet — tests will fail with "command not found" or similar. That is correct and expected (TDD red state).

    Each file must:
    1. Start with `#!/usr/bin/env bats`
    2. Load helpers: `load "helpers/setup"`
    3. Define `setup() { setup_repo; }` and `teardown() { teardown_repo; }`
    4. Use `assert_success`, `assert_failure`, `assert_output` from bats-assert

    For hooks.bats: The hook is invoked directly as `run "$SCRIPTS_DIR/hooks/pre-commit"`. To simulate staged files, use `git add` before running the hook, and set `GIT_DIR="$REPO_DIR/.git"`.

    For the non-TTY test in add.bats: close stdin with `run $SCRIPTS_DIR/add "task" < /dev/null`. If add checks for TTY via `[ -t 0 ]`, passing /dev/null as stdin is sufficient to simulate non-interactive mode.

    Do NOT write placeholder implementations of the scripts. Only write the test files.
  </implementation>
</feature>

<verification>
After writing all six files:
```bash
./tests/libs/bats-core/bin/bats tests/hooks.bats tests/templates.bats tests/add.bats tests/done.bats tests/block.bats tests/drop.bats 2>&1 | tail -20
```
Expected: All tests shown as "not ok" (failed). Zero "ok" lines. Exit code non-zero.
</verification>

<success_criteria>
- Six .bats files exist: hooks.bats, templates.bats, add.bats, done.bats, block.bats, drop.bats
- Each file has correct shebang, loads helpers/setup, defines setup/teardown
- hooks.bats has at least 5 test cases covering the pre-commit hook spec
- templates.bats has at least 7 test cases covering all frontmatter placeholders
- add.bats has at least 9 test cases covering happy path, all flags, non-TTY
- done.bats, block.bats, drop.bats each have at least 4 test cases
- Running bats on these files produces zero passing tests (all red — correct TDD baseline)
</success_criteria>

<output>
After completion, create `.planning/phases/01-test-suite/01-02-SUMMARY.md`
</output>
