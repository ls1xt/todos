---
phase: 03-core-scripts
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - add
autonomous: true
requirements:
  - SCPT-01
  - SCPT-02
  - SCPT-03

must_haves:
  truths:
    - "`add \"buy milk\"` creates `open/YYYY-MM-DD-buy-milk.md` in the current directory"
    - "`add` prints `created: open/<filename>` to stdout"
    - "`add` runs `git add <file> && git commit -m \"add: <title>\"` internally"
    - "`add --priority high` writes `priority: high` in frontmatter"
    - "`add --keywords foo,bar` writes `keywords: foo,bar` in frontmatter"
    - "`add --project myproject` writes `project: myproject` in frontmatter"
    - "`add --body \"some text\"` writes `body: some text` in frontmatter"
    - "`add --transcription \"words\"` writes `transcription: words` in frontmatter"
    - "`add \"task\" < /dev/null` exits 0 without blocking or opening EDITOR"
  artifacts:
    - path: "add"
      provides: "Bash script to create and commit a todo file"
      min_lines: 40
  key_links:
    - from: "add"
      to: "open/<date>-<slug>.md"
      via: "writes file using templates/todo.md frontmatter fields"
      pattern: "open/"
    - from: "add"
      to: "git commit"
      via: "git add <file> && git commit internally"
      pattern: "git commit"
---

<objective>
Implement the `add` bash script at the repo root. The script creates a todo file in `open/` with a date-prefixed slug filename, populates frontmatter from flag arguments, auto-commits, and prints the created filename.

Purpose: Enables voice-driven todo capture — the core user-facing action in the system.
Output: `add` script (executable), all 9 bats tests in `tests/add.bats` passing.
</objective>

<execution_context>
@/home/leon/.claude/get-shit-done/workflows/execute-plan.md
@/home/leon/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@templates/todo.md
@tests/add.bats
@tests/helpers/setup.bash
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write and implement the `add` script</name>
  <files>add</files>
  <action>
Create an executable bash script at the repo root named `add` (no extension).

Script behavior (derived directly from tests/add.bats):

1. **Argument parsing:**
   - First positional arg is the title (required)
   - Flags: `--priority VALUE`, `--keywords VALUE`, `--project VALUE`, `--body VALUE`, `--transcription VALUE`
   - Parse in a while loop with `shift`

2. **Slug generation:**
   - Convert title to slug: lowercase, spaces replaced with hyphens, strip non-alphanumeric characters (keep hyphens)
   - Example: `"buy milk"` → `buy-milk`, `"priority task"` → `priority-task`
   - Keep it simple: `echo "$title" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | tr -cd 'a-z0-9-'`

3. **Date:**
   - `DATE=$(date +%Y-%m-%d)`

4. **Filename:**
   - `FILENAME="${DATE}-${SLUG}.md"`
   - Full path: `open/${FILENAME}`

5. **Frontmatter:**
   - Write a YAML frontmatter block using the same fields as `templates/todo.md`:
     ```
     ---
     created: YYYY-MM-DD
     priority: <value or empty>
     project: <value or empty>
     keywords: <value or empty>
     body: <value or empty>
     transcription: <value or empty>
     ---
     ```
   - When a flag is passed, the value appears after the key: `priority: high`
   - When a flag is NOT passed, the field is present but empty: `priority:` (bare key, no value)
   - Date is always set to `$DATE`

6. **Non-interactive safety:**
   - Must NOT check `[ -t 0 ]` or open `$EDITOR` under any circumstances
   - Script is fully non-interactive — content is entirely determined by flags

7. **Git commit:**
   - `git add "open/${FILENAME}"`
   - `git commit -m "add: ${TITLE}"` (use the raw title argument, not the slug)
   - The `add.bats` setup exports `HOME="$REPO_DIR"` so git identity is available

8. **Stdout output:**
   - Print exactly: `created: open/${FILENAME}`

9. **Make executable:**
   - The file itself must have `#!/usr/bin/env bash` shebang
   - Run `chmod +x add` after writing

Full script structure:
```bash
#!/usr/bin/env bash
set -e

TITLE="$1"
shift

# Defaults
PRIORITY=""
KEYWORDS=""
PROJECT=""
BODY=""
TRANSCRIPTION=""

# Parse flags
while [[ $# -gt 0 ]]; do
  case "$1" in
    --priority)     PRIORITY="$2";     shift 2 ;;
    --keywords)     KEYWORDS="$2";     shift 2 ;;
    --project)      PROJECT="$2";      shift 2 ;;
    --body)         BODY="$2";         shift 2 ;;
    --transcription) TRANSCRIPTION="$2"; shift 2 ;;
    *) shift ;;
  esac
done

DATE=$(date +%Y-%m-%d)
SLUG=$(echo "$TITLE" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | tr -cd 'a-z0-9-')
FILENAME="${DATE}-${SLUG}.md"
FILEPATH="open/${FILENAME}"

cat > "$FILEPATH" <<EOF
---
created: ${DATE}
priority: ${PRIORITY}
project: ${PROJECT}
keywords: ${KEYWORDS}
body: ${BODY}
transcription: ${TRANSCRIPTION}
---
EOF

git add "$FILEPATH"
git commit -m "add: ${TITLE}"

echo "created: ${FILEPATH}"
```

Write this file with the Write tool (do NOT use Bash heredoc/cat to create it).
After writing, run: `chmod +x add`
  </action>
  <verify>
    <automated>cd /home/leon/todos && ./tests/libs/bats-core/bin/bats tests/add.bats</automated>
    <manual>All 9 tests in add.bats should pass: creates file, prints created, auto-commits, all 5 flags set frontmatter, non-TTY completes.</manual>
  </verify>
  <done>
    `./tests/libs/bats-core/bin/bats tests/add.bats` reports 9 tests, 0 failures.
    File `add` exists at repo root, is executable (`chmod +x`), and has the correct shebang.
  </done>
</task>

</tasks>

<verification>
Run the full add test suite:
```bash
./tests/libs/bats-core/bin/bats tests/add.bats
```
Expected: 9 passed, 0 failed.

Also spot-check:
```bash
ls -la add          # executable bit set
head -1 add         # #!/usr/bin/env bash
```
</verification>

<success_criteria>
- `add` script exists at repo root with executable bit set
- All 9 tests in tests/add.bats pass
- SCPT-01: `add <title>` creates `open/YYYY-MM-DD-<slug>.md` and auto-commits
- SCPT-02: All 5 flags (--priority, --keywords, --project, --body, --transcription) populate frontmatter
- SCPT-03: Script completes without blocking when stdin is /dev/null (no TTY)
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-scripts/03-01-SUMMARY.md` with what was built, any decisions made, and the test result.
</output>
