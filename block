#!/usr/bin/env bash
set -e

PATTERN="$1"
TARGET_DIR="blocked"
ACTION="block"

if [[ -z "$PATTERN" ]]; then
  echo "Usage: block <pattern>" >&2
  exit 1
fi

# Find matches in open/
MATCHES=()
if [[ "$PATTERN" =~ ^[0-9]+$ ]]; then
  # Numeric argument: search by id: field in frontmatter
  for f in open/*.md; do
    [[ -f "$f" ]] || continue
    FILE_ID=$(grep -m1 '^id:' "$f" | sed 's/id:[[:space:]]*//')
    [[ "$FILE_ID" == "$PATTERN" ]] && MATCHES+=("$f")
  done
else
  for f in open/*"${PATTERN}"*; do
    [[ -f "$f" ]] && MATCHES+=("$f")
  done
fi

if [[ ${#MATCHES[@]} -eq 0 ]]; then
  echo "no match: $PATTERN" >&2
  exit 1
fi

if [[ ${#MATCHES[@]} -gt 1 ]]; then
  echo "multiple matches:" >&2
  for m in "${MATCHES[@]}"; do
    echo "  $(basename "$m")" >&2
  done
  exit 1
fi

FILE="${MATCHES[0]}"
FILENAME="$(basename "$FILE")"
TITLE="$(echo "$FILENAME" | sed 's/\.md$//' | sed 's/^[0-9]\{4\}-[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}-//')"

git mv "$FILE" "${TARGET_DIR}/${FILENAME}"
git commit -m "${ACTION}: ${TITLE}"
