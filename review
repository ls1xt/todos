#!/usr/bin/env bash
set -e

DAYS=7

while [[ $# -gt 0 ]]; do
  case "$1" in
    --days) DAYS="$2"; shift 2 ;;
    *) shift ;;
  esac
done

# Edge case: 0-day window shows nothing
if [[ "$DAYS" -eq 0 ]]; then
  exit 0
fi

CUTOFF=$(date -d "${DAYS} days ago" +%Y-%m-%d 2>/dev/null \
         || date -v-"${DAYS}"d +%Y-%m-%d 2>/dev/null || true)

for STATUS in open done blocked dropped; do
  [[ -d "$STATUS" ]] || continue

  MATCHES=()
  for file in "$STATUS"/*.md; do
    [[ -f "$file" ]] || continue
    CREATED=$(grep -m1 '^created:' "$file" | sed 's/created:[[:space:]]*//')
    # Include if created >= cutoff (string comparison works for YYYY-MM-DD)
    if [[ "$CREATED" > "$CUTOFF" || "$CREATED" == "$CUTOFF" ]]; then
      MATCHES+=("$file")
    fi
  done

  COUNT="${#MATCHES[@]}"
  if [[ "$COUNT" -gt 0 ]]; then
    echo "${STATUS} (${COUNT})"
    for match in "${MATCHES[@]}"; do
      echo "  $match"
    done
  fi
done
