#!/usr/bin/env bash
set -e

TITLE="$1"
shift

if [[ -z "$TITLE" ]]; then
  echo "Usage: add <title> [--priority VALUE] [--keywords VALUE] [--project VALUE] [--body VALUE] [--transcription VALUE]" >&2
  exit 1
fi

# Defaults
PRIORITY=""
KEYWORDS=""
PROJECT=""
BODY=""
TRANSCRIPTION=""

# Parse flags
while [[ $# -gt 0 ]]; do
  case "$1" in
    --priority)      PRIORITY="$2";      shift 2 ;;
    --keywords)      KEYWORDS="$2";      shift 2 ;;
    --project)       PROJECT="$2";       shift 2 ;;
    --body)          BODY="$2";          shift 2 ;;
    --transcription) TRANSCRIPTION="$2"; shift 2 ;;
    *) shift ;;
  esac
done

# Read and increment ID counter from parent repo root
COUNTER_FILE="$PWD/.next-id"
if [[ -f "$COUNTER_FILE" ]]; then
  ID=$(cat "$COUNTER_FILE")
else
  ID=1
fi
NEXT_ID=$(( ID + 1 ))
printf '%d' "$NEXT_ID" > "$COUNTER_FILE"

DATE=$(date +%Y-%m-%d)
SLUG=$(echo "$TITLE" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | tr -cd 'a-z0-9-')
FILENAME="$(printf '%04d' "$ID")-${DATE}-${SLUG}.md"
FILEPATH="open/${FILENAME}"

cat > "$FILEPATH" <<FRONTMATTER
---
id: ${ID}
created: ${DATE}
priority: ${PRIORITY}
project: ${PROJECT}
keywords: ${KEYWORDS}
body: ${BODY}
transcription: ${TRANSCRIPTION}
---
FRONTMATTER

git add "$FILEPATH" "$COUNTER_FILE"
git commit -m "add: ${TITLE}"

echo "created: ${FILEPATH}"
