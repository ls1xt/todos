#!/usr/bin/env bash
set -e

PATTERN="$1"
TARGET_DIR="dropped"
ACTION="drop"

if [[ -z "$PATTERN" ]]; then
  echo "Usage: drop <pattern>" >&2
  exit 1
fi

# Find matches in open/
MATCHES=()
for f in open/*"${PATTERN}"*; do
  [[ -f "$f" ]] && MATCHES+=("$f")
done

if [[ ${#MATCHES[@]} -eq 0 ]]; then
  echo "no match: $PATTERN" >&2
  exit 1
fi

if [[ ${#MATCHES[@]} -gt 1 ]]; then
  echo "multiple matches:" >&2
  for m in "${MATCHES[@]}"; do
    echo "  $(basename "$m")" >&2
  done
  exit 1
fi

FILE="${MATCHES[0]}"
FILENAME="$(basename "$FILE")"
TITLE="$(echo "$FILENAME" | sed 's/\.md$//' | sed 's/^[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}-//')"

git mv "$FILE" "${TARGET_DIR}/${FILENAME}"
git commit -m "${ACTION}: ${TITLE}"
